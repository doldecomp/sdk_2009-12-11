#include "arithmetic.h"

/*******************************************************************************
 * headers
 */

#include <climits>

#include <macros.h>

#include <revolution/types.h>

#include "constants.h"

/*******************************************************************************
 * types
 */

// [SC5PGN]/build/libs/Debug/slamWiiD.a:math_arithmetic.o(1)::.debug_info::0x109 [original object]
typedef struct /* explicitly untagged */
{
	f32	exp_val;	// size 0x04, offset 0x00
	f32	exp_delta;	// size 0x04, offset 0x04
} ExpSample; // size 0x08

// [SC5PGN]/build/libs/Debug/slamWiiD.a:math_arithmetic.o(1)::.debug_info::0x159 [original object]
typedef struct /* explicitly untagged */
{
	f32	log_val;	// size 0x04, offset 0x00
	f32	log_delta;	// size 0x04, offset 0x04
} LogSample; // size 0x08

/*******************************************************************************
 * local function declarations
 */

namespace nw4hbm { namespace math { namespace
{
	// These functions require the tables, and so are defined later.
	inline f32 FExpLn2(f32 x);
	inline f32 FLog1_2(f32 x);
}}} // namespace nw4hbm::math::(unnamed)

/*******************************************************************************
 * variables
 */

namespace nw4hbm { namespace math { namespace
{
	// .data
	ExpSample sExpTbl[32 + 1] =
	{
		{0.5f,        0.022136891f},
		{0.52213687f, 0.023116974f},
		{0.5452539f,  0.024140451f},
		{0.5693943f,  0.02520924f },
		{0.59460354f, 0.026325349f},
		{0.6209289f,  0.027490871f},
		{0.6484198f,  0.028707996f},
		{0.6771278f,  0.029979007f},
		{0.70710677f, 0.031306293f},
		{0.7384131f,  0.03269234f },
		{0.7711054f,  0.034139752f},
		{0.80524516f, 0.035651248f},
		{0.8408964f,  0.037229665f},
		{0.8781261f,  0.038877964f},
		{0.91700405f, 0.040599238f},
		{0.9576033f,  0.04239672f },
		{1.0f,        0.044273783f},
		{1.0442737f,  0.04623395f },
		{1.0905077f,  0.048280902f},
		{1.1387886f,  0.05041848f },
		{1.1892071f,  0.052650698f},
		{1.2418578f,  0.054981742f},
		{1.2968396f,  0.057415992f},
		{1.3542556f,  0.059958015f},
		{1.4142135f,  0.062612586f},
		{1.4768262f,  0.06538468f },
		{1.5422108f,  0.068279505f},
		{1.6104903f,  0.071302496f},
		{1.6817929f,  0.07445933f },
		{1.7562522f,  0.07775593f },
		{1.8340081f,  0.081198476f},
		{1.9152066f,  0.08479344f },
		{2.0f,        0.088547565f}
	};

	LogSample sLogTbl[256 + 1] =
	{
		{0.0f,         0.00389864f },
		{0.00389864f,  0.0038835f  },
		{0.00778214f,  0.003868477f},
		{0.011650617f, 0.003853569f},
		{0.015504187f, 0.003838776f},
		{0.019342963f, 0.003824096f},
		{0.023167059f, 0.003809528f},
		{0.026976587f, 0.003795071f},
		{0.03077166f,  0.003780723f},
		{0.03455238f,  0.003766483f},
		{0.038318865f, 0.00375235f },
		{0.042071216f, 0.003738322f},
		{0.045809537f, 0.003724399f},
		{0.049533933f, 0.003710579f},
		{0.053244516f, 0.003696862f},
		{0.056941375f, 0.003683245f},
		{0.06062462f,  0.003669729f},
		{0.06429435f,  0.003656311f},
		{0.06795066f,  0.003642991f},
		{0.07159365f,  0.003629768f},
		{0.07522342f,  0.00361664f },
		{0.07884006f,  0.003603608f},
		{0.08244367f,  0.003590668f},
		{0.086034335f, 0.003577821f},
		{0.089612156f, 0.003565066f},
		{0.09317722f,  0.003552402f},
		{0.09672963f,  0.003539827f},
		{0.10026945f,  0.003527341f},
		{0.103796795f, 0.003514942f},
		{0.10731173f,  0.003502631f},
		{0.11081436f,  0.003490405f},
		{0.11430477f,  0.003478264f},
		{0.11778303f,  0.003466208f},
		{0.12124924f,  0.003454235f},
		{0.12470348f,  0.003442344f},
		{0.12814583f,  0.003430535f},
		{0.13157636f,  0.003418807f},
		{0.13499516f,  0.003407158f},
		{0.13840233f,  0.003395589f},
		{0.14179792f,  0.003384098f},
		{0.14518201f,  0.003372684f},
		{0.1485547f,   0.003361348f},
		{0.15191604f,  0.003350087f},
		{0.15526614f,  0.003338901f},
		{0.15860502f,  0.00332779f },
		{0.16193283f,  0.003316753f},
		{0.16524957f,  0.003305788f},
		{0.16855536f,  0.003294896f},
		{0.17185026f,  0.003284075f},
		{0.17513433f,  0.003273325f},
		{0.17840765f,  0.003262646f},
		{0.18167031f,  0.003252035f},
		{0.18492234f,  0.003241494f},
		{0.18816383f,  0.003231021f},
		{0.19139485f,  0.003220615f},
		{0.19461547f,  0.003210276f},
		{0.19782574f,  0.003200003f},
		{0.20102574f,  0.003189795f},
		{0.20421554f,  0.003179653f},
		{0.2073952f,   0.003169575f},
		{0.21056476f,  0.00315956f },
		{0.21372433f,  0.003149609f},
		{0.21687394f,  0.00313972f },
		{0.22001366f,  0.003129893f},
		{0.22314355f,  0.003120127f},
		{0.22626367f,  0.003110422f},
		{0.2293741f,   0.003100778f},
		{0.23247488f,  0.003091193f},
		{0.23556606f,  0.003081667f},
		{0.23864774f,  0.003072199f},
		{0.24171993f,  0.00306279f },
		{0.24478273f,  0.003053437f},
		{0.24783616f,  0.003044142f},
		{0.2508803f,   0.003034904f},
		{0.25391522f,  0.003025721f},
		{0.25694093f,  0.003016594f},
		{0.25995752f,  0.003007521f},
		{0.26296505f,  0.002998503f},
		{0.26596355f,  0.002989539f},
		{0.26895308f,  0.002980628f},
		{0.2719337f,   0.00297177f },
		{0.27490547f,  0.002962965f},
		{0.27786845f,  0.002954212f},
		{0.28082266f,  0.00294551f },
		{0.28376818f,  0.00293686f },
		{0.28670505f,  0.00292826f },
		{0.2896333f,   0.00291971f },
		{0.292553f,    0.00291121f },
		{0.29546422f,  0.00290276f },
		{0.29836696f,  0.002894358f},
		{0.30126134f,  0.002886005f},
		{0.30414733f,  0.0028777f  },
		{0.30702505f,  0.002869442f},
		{0.30989447f,  0.002861232f},
		{0.3127557f,   0.002853069f},
		{0.31560877f,  0.002844952f},
		{0.31845373f,  0.002836881f},
		{0.3212906f,   0.002828856f},
		{0.32411948f,  0.002820876f},
		{0.32694036f,  0.002812941f},
		{0.32975328f,  0.002805051f},
		{0.33255833f,  0.002797205f},
		{0.33535555f,  0.002789402f},
		{0.33814496f,  0.002781643f},
		{0.3409266f,   0.002773927f},
		{0.34370053f,  0.002766253f},
		{0.34646678f,  0.002758622f},
		{0.3492254f,   0.002751033f},
		{0.35197642f,  0.002743486f},
		{0.3547199f,   0.00273598f },
		{0.35745588f,  0.002728515f},
		{0.3601844f,   0.00272109f },
		{0.3629055f,   0.002713706f},
		{0.3656192f,   0.002706362f},
		{0.36832556f,  0.002699057f},
		{0.3710246f,   0.002691792f},
		{0.3737164f,   0.002684565f},
		{0.37640098f,  0.002677378f},
		{0.37907836f,  0.002670229f},
		{0.3817486f,   0.002663117f},
		{0.3844117f,   0.002656044f},
		{0.38706774f,  0.002649008f},
		{0.38971674f,  0.002642009f},
		{0.39235875f,  0.002635048f},
		{0.3949938f,   0.002628122f},
		{0.39762193f,  0.002621233f},
		{0.40024316f,  0.002614381f},
		{0.40285754f,  0.002607563f},
		{0.4054651f,   0.002600782f},
		{0.4080659f,   0.002594035f},
		{0.41065994f,  0.002587324f},
		{0.41324726f,  0.002580647f},
		{0.4158279f,   0.002574004f},
		{0.4184019f,   0.002567396f},
		{0.4209693f,   0.002560821f},
		{0.4235301f,   0.00255428f },
		{0.4260844f,   0.002547772f},
		{0.42863217f,  0.002541297f},
		{0.43117347f,  0.002534856f},
		{0.4337083f,   0.002528446f},
		{0.43623677f,  0.002522069f},
		{0.43875885f,  0.002515725f},
		{0.44127455f,  0.002509412f},
		{0.44378397f,  0.00250313f },
		{0.4462871f,   0.00249688f },
		{0.448784f,    0.002490661f},
		{0.45127463f,  0.002484473f},
		{0.4537591f,   0.002478316f},
		{0.45623744f,  0.002472189f},
		{0.45870963f,  0.002466092f},
		{0.4611757f,   0.002460026f},
		{0.46363574f,  0.002453989f},
		{0.46608973f,  0.002447982f},
		{0.46853772f,  0.002442004f},
		{0.47097972f,  0.002436055f},
		{0.47341576f,  0.002430135f},
		{0.4758459f,   0.002424244f},
		{0.47827014f,  0.002418381f},
		{0.48068854f,  0.002412546f},
		{0.48310107f,  0.00240674f },
		{0.48550782f,  0.002400962f},
		{0.48790878f,  0.002395211f},
		{0.490304f,    0.002389487f},
		{0.49269348f,  0.002383791f},
		{0.49507725f,  0.002378122f},
		{0.4974554f,   0.00237248f },
		{0.49982786f,  0.002366865f},
		{0.50219476f,  0.002361276f},
		{0.504556f,    0.002355714f},
		{0.5069117f,   0.002350177f},
		{0.5092619f,   0.002344667f},
		{0.5116066f,   0.002339182f},
		{0.51394576f,  0.002333723f},
		{0.51627946f,  0.00232829f },
		{0.51860774f,  0.002322881f},
		{0.52093065f,  0.002317498f},
		{0.52324814f,  0.00231214f },
		{0.52556026f,  0.002306806f},
		{0.5278671f,   0.002301497f},
		{0.5301686f,   0.002296212f},
		{0.5324648f,   0.002290952f},
		{0.53475577f,  0.002285715f},
		{0.5370415f,   0.002280503f},
		{0.53932196f,  0.002275314f},
		{0.5415973f,   0.002270149f},
		{0.5438674f,   0.002265007f},
		{0.54613245f,  0.002259888f},
		{0.54839236f,  0.002254792f},
		{0.55064714f,  0.00224972f },
		{0.55289686f,  0.00224467f },
		{0.5551415f,   0.002239643f},
		{0.55738115f,  0.002234638f},
		{0.5596158f,   0.002229655f},
		{0.5618454f,   0.002224695f},
		{0.56407017f,  0.002219757f},
		{0.5662899f,   0.00221484f },
		{0.56850475f,  0.002209946f},
		{0.57071465f,  0.002205073f},
		{0.5729197f,   0.002200221f},
		{0.57512f,     0.002195391f},
		{0.5773154f,   0.002190581f},
		{0.5795059f,   0.002185793f},
		{0.58169174f,  0.002181026f},
		{0.5838728f,   0.002176279f},
		{0.586049f,    0.002171554f},
		{0.5882206f,   0.002166848f},
		{0.59038746f,  0.002162163f},
		{0.5925496f,   0.002157498f},
		{0.59470713f,  0.002152853f},
		{0.59685993f,  0.002148229f},
		{0.5990082f,   0.002143624f},
		{0.6011518f,   0.002139038f},
		{0.60329086f,  0.002134473f},
		{0.6054253f,   0.002129926f},
		{0.60755527f,  0.002125399f},
		{0.60968065f,  0.002120892f},
		{0.61180156f,  0.002116403f},
		{0.61391795f,  0.002111933f},
		{0.61602986f,  0.002107482f},
		{0.61813736f,  0.00210305f },
		{0.6202404f,   0.002098637f},
		{0.62233907f,  0.002094242f},
		{0.6244333f,   0.002089865f},
		{0.62652314f,  0.002085506f},
		{0.62860864f,  0.002081166f},
		{0.6306898f,   0.002076844f},
		{0.63276666f,  0.00207254f },
		{0.63483924f,  0.002068253f},
		{0.63690746f,  0.002063984f},
		{0.63897145f,  0.002059733f},
		{0.6410312f,   0.002055499f},
		{0.6430867f,   0.002051283f},
		{0.64513797f,  0.002047084f},
		{0.647185f,    0.002042902f},
		{0.649228f,    0.002038737f},
		{0.6512667f,   0.002034589f},
		{0.6533013f,   0.002030458f},
		{0.65533173f,  0.002026343f},
		{0.65735805f,  0.002022245f},
		{0.6593803f,   0.002018164f},
		{0.6613985f,   0.002014099f},
		{0.6634126f,   0.002010051f},
		{0.6654226f,   0.002006019f},
		{0.6674287f,   0.002002003f},
		{0.6694307f,   0.001998003f},
		{0.6714287f,   0.001994019f},
		{0.6734227f,   0.00199005f },
		{0.6754127f,   0.001986098f},
		{0.6773988f,   0.001982161f},
		{0.679381f,    0.00197824f },
		{0.68135923f,  0.001974334f},
		{0.6833336f,   0.001970444f},
		{0.685304f,    0.001966569f},
		{0.6872706f,   0.001962709f},
		{0.6892333f,   0.001958864f},
		{0.69119215f,  0.001955035f},
		{0.6931472f,   0.00195122f }
	};
}}} // namespace nw4hbm::math::(unnamed)

/*******************************************************************************
 * functions
 */

namespace nw4hbm { namespace math {

namespace {

f32 FExpLn2(f32 x)
{
	f32 fidx = 16 / Ln2 * (Ln2 + x);
	u16 idx = F32ToU16(fidx);
	f32 r = fidx - U16ToF32(idx);

	return sExpTbl[idx].exp_val + r * sExpTbl[idx].exp_delta;
}

f32 FLog1_2(f32 x)
{
	f32 fidx = 256.0f * (x - 1.0f);
	u16 idx = F32ToU16(fidx);
	f32 r = fidx - U16ToF32(idx);

	return sLogTbl[idx].log_val + r * sLogTbl[idx].log_delta;
}

} // unnamed namespace

namespace detail {

f32 FExp(f32 x)
{
	s16 k = F32ToS16(1 / Ln2 * x);
	f32 kf = S16ToF32(k);
	f32 xn = x - Ln2 * kf;
	f32 expxn = FExpLn2(xn);

	u32 expx = (k << 23) + F32AsU32(expxn) & ~0x80000000;

	return U32AsF32(expx);
}

f32 FLog(f32 x)
{
	s32 k;
	f32 kf;
	f32 xn;
	f32 logxn;

	// the assignments of kf and xn are swapped for some reason
	k = FGetExpPart(x);
	xn = FGetMantPart(x);
	kf = S16ToF32(k);
	logxn = FLog1_2(xn);

	return logxn + Ln2 * kf;
}

} // namespace detail

f32 FrSqrt(register f32 x)
{
	register f32 rsqrt;
	register f32 /* const */ c_half = 0.5f;
	register f32 /* const */ c_three = 3.0f;
	register f32 nwork0, nwork1;

#if defined(__MWERKS__)
	asm
	{
		// no evil floating point bit level hacking here

		// what the normal?
		frsqrte	rsqrt, x

		// first iteration
		fmuls	nwork0, rsqrt, rsqrt
		fmuls	nwork1, rsqrt, c_half
		fnmsubs	nwork0, nwork0, x, c_three
		fmuls	rsqrt, nwork0, nwork1

		// the other iteration was removed. they said i could
	}
#else
# pragma unused(x, c_half, c_three, nwork0, nwork1)
	rsqrt = 0;
#endif

	return rsqrt;
}

f32 Hermite(f32 p1, f32 t1, f32 p2, f32 t2, f32 s)
{
	f32 SS = s * s;
	f32 SSmS = s * s - s;
	f32 b1 = SSmS * s - SSmS;
	f32 b2 = SSmS * s;
	f32 a2 = SS - 2.0f * b2;

	return p1 - a2 * p1 + a2 * p2 + b1 * t1 + b2 * t2;
}

f32 Bezier(f32 p1, f32 p2, f32 p3, f32 p4, f32 s)
{
	f32 t = 1.0f - s;
	f32 tt = t * t;
	f32 ss = s * s;
	f32 a1 = tt * t;
	f32 a2 = tt * s * 3.0f;
	f32 a3 = ss * t * 3.0f;
	f32 a4 = ss * s;

	return a1 * p1 + a2 * p2 + a3 * p3 + a4 * p4;
}

f32 CatmullRom(f32 p0, f32 p1, f32 p2, f32 p3, f32 s)
{
	return Hermite(p1, (p0 + p2) * 0.5f, p2, (p1 + p3) * 0.5f, s);
}

u32 CntBit1(u32 x)
{
	// TODO: Probably wrong
	// NOTE: It actually is not wrong lol

	x = x - (x >> 1 & 0x55555555);
	x = (x & 0x33333333) + (x >> 2 & 0x33333333);
	x = ((x + (x >> 4)) & 0x0f0f0f0f);
	x = x + (x >> 8);
	x = x + (x >> 16);

	return x % 64;
}

u32 CntBit1(u32 const *first, u32 const *last)
{
	u32 n = last - first;

	u32 i, j, lim;
	unsigned s = 0;
	unsigned ss, x;

	for (i = 0; i < n; i += 31)
	{
		lim = MIN(n, i + 31);

		ss = 0;

		for (j = i; j < lim; ++j)
		{
			x = first[j];
			x = x - (x >> 1 & 0x55555555);
			x = (x & 0x33333333) + (x >> 2 & 0x33333333);
			x = ((x + (x >> 4)) & 0x0f0f0f0f);

			ss += x;
		}

		x = (ss & 0x00ff00ff) + ((ss >> 8) & 0x00ff00ff);
		x = (x & 0x0000ffff) + ((x >> 16) & 0x0000ffff);

		s += x;
	}

	return s;
}

u32 DistBit(u32 const *first1, u32 const *last1, u32 const *first2)
{
	unsigned n = 0;

	while (first1 != last1)
	{
		n += DistBit(*first1, *first2);

		++first1;
		++first2;
	}

	return n;
}

u32 RevBit(u32 x)
{
	x = ((x & 0x55555555) << 1) | ((x >> 1) & 0x55555555);
	x = ((x & 0x33333333) << 2) | ((x >> 2) & 0x33333333);
	x = ((x & 0x0f0f0f0f) << 4) | ((x >> 4) & 0x0f0f0f0f);
	return x << 24 | ((x & 0xff00) << 8) | ((x >> 8) & 0xff00) | x >> 24;
}

int IExp(int x, u32 n)
{
	int p, y;

	y = 1;
	p = x;

	while (true)
	{
		if (n % 2)
			y *= p;

		n /= 2;

		if (n == 0)
			return y;

		p *= p;
	}
}

u32 ILog10(u32 x)
{
	static u32 table2[] =
	{
		1 - 1,
		10 - 1,
		100 - 1,
		1000 - 1,
		10000 - 1,
		100000 - 1,
		1000000 - 1,
		10000000 - 1,
		100000000 - 1,
		1000000000 - 1,

		ULONG_MAX
	};

	u32 y = (31 - CntLz(x)) * 19 / 64;

	y += (table2[y + 1] - x) >> 31;

	return y;
}

namespace detail {

u32 CntLz_(u32 x)
{
	// "Manually", as it were

	unsigned y;
	int n = 32, c = 16;

	do
	{
		y = x >> c;

		if (y != 0)
		{
			n -= c;
			x = y;
		}

		c >>= 1;
	} while (c);

	return n - x;
}

} // namespace detail

}} // namespace nw4hbm::math
