#ifndef NW4HBM_LYT_ANIMATION_H
#define NW4HBM_LYT_ANIMATION_H

/*******************************************************************************
 * headers
 */

#include <revolution/types.h>

#include "../macros.h"

#include "common.h"

#include "../ut/LinkList.h"

/*******************************************************************************
 * classes and functions
 */

// context declarations
namespace nw4hbm { namespace lyt { class Material; }}
namespace nw4hbm { namespace lyt { class Pane; }}
namespace nw4hbm { namespace lyt { class ResourceAccessor; }}

namespace nw4hbm { namespace lyt
{
	// forward declarations
	class AnimTransform;

	namespace res
	{
		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0xe7b [original object]
		struct AnimationBlock
		{
			DataBlockHeader	blockHeader;			// size 0x08, offset 0x00
			u16				frameSize;				// size 0x02, offset 0x08
			u8				loop;					// size 0x01, offset 0x0a
			byte1_t			padding1;
			u16				fileNum;				// size 0x02, offset 0x0c
			u16				animContNum;			// size 0x02, offset 0x0e
			u32				animContOffsetsOffset;	// size 0x04, offset 0x10
		}; // size 0x14

		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0x1115 [original object]
		struct AnimationContent
		{
		// enums
		public:
			typedef u8 ACType;
			enum ACType_et
			{
				ACType_Pane,
				ACType_Material
			};

		// static members
		public:
			static u32 const NAME_LENGTH = 20;

		// members
		public:
			char	name[NAME_LENGTH];	// size 0x14, offset 0x00
			u8		num;				// size 0x01, offset 0x14
			ACType	type;				// size 0x01, offset 0x15
			byte_t	padding[2];
		}; // size 0x18

		// presumably PaneAnimInfo1. It fits, at least...
		static byte4_t const SIGNATURE_ANIM_INFO_BLOCK =
			NW4HBM_FOUR_CHAR('p', 'a', 'i', '1');

		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0xbbc [original object]
		struct AnimationInfo
		{
		// static members
		public:
			static byte4_t const SIGNATURE_PANE_PAIN_SRT_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'P', 'A');
			static byte4_t const SIGNATURE_PANE_VERTEX_COLOR_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'V', 'C');
			static byte4_t const SIGNATURE_PANE_VISIBILITY_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'V', 'I');

			static byte4_t const SIGNATURE_MATERIAL_IND_TEX_SRT_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'I', 'M');
			static byte4_t const SIGNATURE_MATERIAL_COLOR_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'M', 'C');
			static byte4_t const SIGNATURE_MATERIAL_TEXTURE_PATTERN_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'T', 'P');
			static byte4_t const SIGNATURE_MATERIAL_TEXTURE_SRT_INFO =
				NW4HBM_FOUR_CHAR('R', 'L', 'T', 'S');

		// members
		public:
			byte4_t	kind;	// size 0x04, offset 0x00
			u8		num;	// size 0x01, offset 0x04
			byte_t	padding[3];
		}; // size 0x08

		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0xc21 [original object]
		struct AnimationTarget
		{
			u8		id;			// size 0x01, offset 0x00
			u8		target;		// size 0x01, offset 0x01
			u8		curveType;	// size 0x01, offset 0x02
			byte1_t	padding1;
			u16		keyNum;		// size 0x02, offset 0x04
			byte_t	padding2[2];
			u32		keysOffset;	// size 0x04, offset 0x08
		}; // size 0x0c

		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animaion.o(1)::.debug_info::0x241 [original object]
		struct HermiteKey
		{
			f32	frame;	// size 0x04, offset 0x00
			f32	value;	// size 0x04, offset 0x04
			f32	slope;	// size 0x04, offset 0x08
		}; // size 0x0c

		// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0x1c8 [original object]
		struct StepKey
		{
			f32		frame;	// size 0x04, offset 0x00
			u16		value;	// size 0x02, offset 0x04
			byte2_t	padding;
		}; // size 0x08

		static byte4_t const SIGNATURE_ANIMATION =
			NW4HBM_FOUR_CHAR('R', 'L', 'A', 'N');
	} // namespace res

	// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0x1010 [original object]
	class AnimationLink
	{
	// typedefs
	public:
		/* offsetof(AnimationLink, mLink) */
		typedef ut::LinkList<AnimationLink, 0> LinkList;

	// methods
	public:
		// cdtors
		AnimationLink():
			mbDisable	(false)
		{
			Reset();
		}

		/* ~AnimationLink() = default; */

		// methods
		AnimTransform *GetAnimTransform() const { return mAnimTrans; }
		u16 GetIndex() const { return mIdx; }
		bool IsEnable() const { return !mbDisable; }

		void SetAnimTransform(AnimTransform *animTrans, u16 idx)
		{
			mAnimTrans = animTrans;
			mIdx = idx;
		}

		void SetEnable(bool bEnable) { mbDisable = !bEnable; }

		void Reset() { SetAnimTransform(nullptr, 0); }

	// members
	private:
		ut::LinkListNode	mLink;			// size 0x08, offset 0x00
		AnimTransform		*mAnimTrans;	// size 0x04, offset 0x08
		u16					mIdx;			// size 0x02, offset 0x0c
		bool				mbDisable;		// size 0x01, offset 0x0e
		/* 1 byte padding */
	}; // size 0x10

	// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0xe2f [original object]
	class AnimTransform
	{
	// typedefs
	public:
		/* offsetof(AnimTransform, mLink) */
		typedef ut::LinkList<AnimTransform, 4> LinkList;

	// methods
	public:
		// cdtors
		AnimTransform();
		virtual ~AnimTransform();

		// virtual function ordering
		// vtable AnimTransform
		virtual void SetResource(res::AnimationBlock const *pRes,
		                         ResourceAccessor *pResAccessor) = 0;
		virtual void Bind(Pane *pPane, bool bRecursive) = 0;
		virtual void Bind(Material *pMaterial) = 0;
		virtual void Animate(u32 idx, Pane *pPane) = 0;
		virtual void Animate(u32 idx, Material *pMaterial) = 0;

		// methods
		f32 GetFrameMax() const { return static_cast<f32>(GetFrameSize()); }
		u16 GetFrameSize() const;

		void SetFrame(f32 frame) { mFrame = frame; }

		bool IsLoopData() const;

	// members
	protected: // AnimTransformBasic::SetResource
		/* vtable */						// size 0x04, offset 0x00
		ut::LinkListNode	mLink;			// size 0x08, offset 0x04
		res::AnimationBlock const *mpRes;   // size 0x04, offset 0x0c
		f32					mFrame;			// size 0x04, offset 0x10
	}; // size 0x14

	// [SC5PGN]/build/libs/Debug/slamWiiD.a:lyt_animation.o(1)::.debug_info::0xf93 [original object]
	class AnimTransformBasic : public AnimTransform
	{
	// methods
	public:
		// cdtors
		AnimTransformBasic();
		virtual ~AnimTransformBasic();

		// virtual function ordering
		// vtable AnimTransform
		virtual void SetResource(res::AnimationBlock const *pRes,
		                         ResourceAccessor *pResAccessor);
		virtual void Bind(Pane *pPane, bool bRecursive);
		virtual void Bind(Material *pMaterial);
		virtual void Animate(u32 idx, Pane *pPane);
		virtual void Animate(u32 idx, Material *pMaterial);

	// members
	private:
		/* base AnimTransform */		// size 0x14, offset 0x00
		void			**mpFileResAry;	// size 0x04, offset 0x14
		AnimationLink	*mAnimLinkAry;	// size 0x04, offset 0x18
		u16				mAnimLinkNum;	// size 0x02, offset 0x1c
		/* 2 bytes padding */
	}; // size 0x20

	namespace detail
	{
		AnimationLink *FindAnimationLink(AnimationLink::LinkList *pAnimList,
		                                 AnimTransform *pAnimTrans);
	} // namespace detail
}} // namespace nw4hbm::lyt

#endif // NW4HBM_LYT_ANIMATION_H
